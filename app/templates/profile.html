{% extends "base.html" %}

{% block content %}
<body class="bg-gray-100 h-screen flex items-center justify-center">
    <div class="w-full max-w-4xl h-3/4 flex border rounded-lg shadow-lg bg-white">
        <!-- User List -->
        <div class="w-1/4 p-4 border-r overflow-y-auto">
            <h2 class="text-xl font-semibold mb-4">Current users</h2>
            <ul id="userList" class="space-y-2">
                <li class="p-2 bg-blue-500 rounded text-white">{{ username }}</li>
                <hr/>
                <!-- Example User List Items -->
                <li class="p-2 bg-gray-200 rounded">user1</li>
                <li class="p-2 bg-gray-200 rounded">user2</li>
                <li class="p-2 bg-gray-200 rounded">user3</li>
            </ul>
        </div>
        <!-- Message Container -->
        <div class="w-3/4 flex flex-col p-4">
            <div id="messageContainer" class="flex-1 overflow-y-auto mb-4 p-4 border rounded bg-gray-50">
                <!-- Messages will appear here -->
            </div>
            <!-- Message Form -->
            <form id="messageForm" class="flex">
                <input id="messageInput" type="text" placeholder="Type your message..." class="flex-1 p-2 border rounded-l-lg focus:outline-none">
                <button type="submit" class="p-2 bg-blue-500 text-white rounded-r-lg">Send</button>
            </form>
        </div>
    </div>
    <script>
        async function createMessageRequest(content) {
            const token = localStorage.getItem("anonChatRoom");
            const response = await fetch(`${window.location.origin}/messages/create`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ content: content })
            });

            if (!response.ok) {
                // throw new Error(`${response.status}:${response.statusText}`);
                showFlashNotification("red", "Could not authenticate user!");
            }

            const data = await response.json();
            return data;
        }

        document.getElementById('messageForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();

            if (messageText !== "") {

                try {
                    const messageData = await createMessageRequest(messageText);
                    
                    const messageContainer = document.getElementById('messageContainer');
                    const messageWrapper = document.createElement('div');
                    messageWrapper.className = "mb-2";
                    const messageUsername = document.createElement('div');
                    messageUsername.className = "text-xs text-gray-500";
                    messageUsername.textContent = messageData.owner.username;
                    const messageElement = document.createElement('div');
                    messageElement.className = "p-2 bg-blue-100 rounded";
                    messageElement.textContent = messageData.content;
                    
                    messageWrapper.appendChild(messageUsername);
                    messageWrapper.appendChild(messageElement);
                    
                    messageContainer.appendChild(messageWrapper);
                    messageInput.value = "";
                    messageContainer.scrollTop = messageContainer.scrollHeight;
                    
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        });
    </script>
</body>
{% endblock %}